# Agent Log

## 2024-05-05
- Profile grid now stays hidden until real grid data (either cached or freshly fetched) is applied. Once hydrated we fade/scale the entire grid container in with a 520 ms cubic-out animation so prompts and tiles arrive as a single unit.
- Messaging bootstrap loads conversations with expanded membership data, flattens those memberships into the store and cache, and hydrates previews from that flattened data. Conversation avatars are available on first render instead of arriving after subsequent fetches.
- Grid animation now plays only once per user profile. Subsequent visits reuse cached animation state so the grid stays visible without re-running the intro tween.
- Navigation back button first checks history (router/native) before falling back to profile replacement, and the profile screen now skips the "force grid" reset whenever a pending pager index is queued—so returning from Directories or Want-to-Meet lands on the correct tab.
- Directory view now syncs its People/Popular filter with the global store; when we navigate back from a drilled profile we reapply the last filter (and queue it during fallback) so you land on the same People tab you left.
- Added a dedicated logout bottom sheet (long-press the Refs wordmark) so logout no longer renders an inline overlay and stays consistent with other sheet interactions.
- Font loader no longer blocks the app tree; we render immediately with system fonts and swap in Inter once it's ready, so the splash screen disappears without gating gestures.
- Messaging bootstrap hydrates from cache instantly and defers the multi-query PocketBase fetch until after interactions, keeping the JS queue free during launch.

## 2025-??-??
- Attempted overlay height spacer approach for settings, but it still flashed; backed out.
- Swapped to a dedicated settings bottom sheet: pencil opens the sheet (`BottomSheet`), settings live there, FAB fades via opacity when edit mode is active, so the grid stays untouched and no more black flash.
- Refined the settings sheet snap logic to avoid `CONTENT_HEIGHT` snap errors: compute numeric snap points from measured content/fallback heights, keep the 50px radius, and pad the scroll container so the grid stays editable beneath the open sheet.
- Reinstated the shared `NavigationBackdrop` (ordered beneath sheets) so global dimming stays consistent, while OtherProfile's avatar zoom still registers/unregisters backdrop presses to close cleanly without leaking edit state.
- Push registration now treats Expo/Supabase outages as informational only—skips token writes and logs debug info instead of throwing alerts when the APIs are unavailable.
- Added a lightweight navigation overlay tied to the remove-ref sheet so the header dims while the sheet stays bright; remove-ref sheet now matches the community interest sheet styling (fixed snap, rounded 50px, consistent backdrop).
- Added a tiny idle-task queue (`features/utils/idleQueue.ts`) and now feed warmups enqueue one profile at a time—each preload only fetches six grid/backlog items so JS stays responsive.
- MyProfile skips the redundant post-interaction refresh and instead queues a background fetch once cached data is on screen, keeping the screen tappable instantly.
- Referencers sheet now seeds the list with the interest creator (and the viewer if subscribed) so a brand new community always shows at least the host.
- While aligning the profile grid we tried three approaches that did **not** fix the right-edge drift:
  - Added padding directly on the animated grid wrapper (`paddingHorizontal: s.$1 + 6` then `-2`), but the absolute overlay still pinned the inner grid to the right.
  - Offsetting the absolute container with manual `left/right` values and later converting to wrapper padding simply changed the overlay bounds while the `Grid` component continued using its own internal padding, so the tiles never shifted.
  - Syncing the outer wrapper to copy the nav inset without mirroring whatever `Grid` does on main; result was still right-aligned because `Grid`'s internal layout (and possibly its prompt placeholders) control the true tile width.
- Need to diff `Grid.tsx` between main and this branch—likely the internal spacing or content width differs there. Any future alignment tweak should modify `Grid` itself (or its parent layout) rather than stacking more padding around the absolute container.
- Reintroduced padding on the outer profile container (`paddingHorizontal: s.$1 + 6`) and removed ad-hoc padding from the grid wrapper/overlay so the layout matches `main`. Floating FAB now offsets using the same inset; grid still needs validation on device to confirm centering.
- Final fix for right-edge drift: leave container padding at `s.$1 + 6` and explicitly pass `rowJustify="center"` to `<Grid />` so each row centers within the available width (matching `main`).
- Matched the refreshed profile header layout on `OtherProfile`, including the slimmer Inter Medium 13pt location label, and added a tap-to-zoom avatar overlay with a spring scale/opacity animation to preview other users' photos without leaving the screen.
- Introduced `c.newDark` (`#707070`) for primary headers (profile names, Edge Directory, Edge Corkboard, messages) and tightened avatar styling with concentric circular strokes on both self and other profile screens.
- Updated `c.surface2` to `#F4F1E9` to align background accents across prompts, placeholder chips, and avatar rings with the latest palette.
- Centered directory/want-to-meet list styling: default names now render in black, subtitles in `c.newDark`, and corkboard instructional copy swaps to `c.newDark` for consistency across guidance text.
- Matched vertical spacing between name/location rows in directory and Want To Meet pills by giving `UserListItem` the same 2px stack gap used in directory rows.
- Aligned want-to-meet name typography with the directory list by bumping `UserListItem`'s non-small name font to `(s.$09 + 1)` so both tabs read identically.
- Synced avatar and padding dims across directory/Want To Meet by setting `UserListItem`'s large avatar to 60px with matching `s.$075` paddings; rows now match the directory pill measurements.
- Added inline quick-save ribbon to directory rows: custom bookmark outline uses `c.newDark`, fills when saved, and toggles via `addSave`/`removeSave` without leaving the list.
- Replaced Ionicons bookmark with a rounded SVG version sized ~30×36px for better proportions and visibility.
- Synced directory vs. Want To Meet display logic: combined first+last names where available, location fallback now "Elsewhere", and `UserListItem` shares the same defaults so both tabs stay consistent.
- Navigation heart now just opens its sheet (no save badge/animation) as we prepare to repurpose it into a feed.
- Optimistic saves now animate instantly: directory bookmark scales on tap, the Want To Meet count pulses on change, and the saves store keeps optimistic placeholders while the network call completes.
- Saves bottom sheet is currently a placeholder (no list) so the heart entry can evolve into a future feed without showing stale data.
- Directory avatar zoom now drives `otherProfileBackdropAnimatedIndex` so the global nav dimming animates in sync with the overlay; we tween that shared value to `0`/`-1` alongside the opacity/scale springs to keep dismissal and backdrop lighting perfectly aligned.
- Messages screen exit now hands navigation off after a 160 ms fade-out, using the `SwipeToGoBack` hook-in to let the underlying profile surface fade back in without timers or extra effects.
- Fixed "Rendered fewer hooks than expected" error when navigating to community chats by moving all React hooks in `/app/messages/[conversationId]/index.tsx` to be called BEFORE any conditional returns, ensuring hooks are always called in the same order per React's rules.
- Corrected timestamp format for community chat preview messages: replaced `.toISOString()` with PocketBase's expected format (`'yyyy-MM-dd HH:mm:ss.SSSZ'`) by converting the `T` separator to a space, eliminating "Invalid DateTime" errors in the messages list.
- Fixed chat header jumping issue in `MessagesScreen`: replaced `SafeAreaView` with absolute positioning and negative `top` offset with a regular `View` that uses `insets.top` directly in `paddingTop`. The header now stays in position from the start without any jump or shift when entering a chat.
- Implemented message input bar as absolutely positioned at bottom of screen to prevent it from being pushed off-screen by message content; swapped FlatList padding (inverted lists use `paddingTop` for visual bottom space).
- **RESOLVED**: Directory "Everyone" tab was showing empty in production due to silent error handling and potential empty cache issues:
  - Root cause 1: Silent catch block in `fetchPage` (line 783) was swallowing all errors without logging - added detailed error logging
  - Root cause 2: Cache validation was not checking for empty arrays - empty cache `[]` would pass validation and return 0 users
  - Fixed by adding `cachedUsers.length > 0` check before using cached data
  - Added comprehensive logging throughout directory fetch flow to debug future issues
  - Verified: Production DB has 16 users with `show_in_directory=true`, API queries work correctly, field exists in schema
- **CRITICAL FIX**: Registration flow was completely broken - UnifiedOnboarding was calling `registerUser({params})` but `register()` doesn't accept parameters; it reads from `stagedUser` in the store. Fixed by calling `updateStagedUser()` first to stage the data, then calling `register()` with no parameters. This was preventing ALL new user signups.
- Fixed password field autofill issues: Changed `textContentType` from `'oneTimeCode'` to `'newPassword'`/`'password'` and `autoComplete` from `'off'` to `'password'` so iOS properly suggests strong passwords and password managers work correctly.
- Push notifications are iOS-only for now; Expo token registration runs via `RegisterPushNotifications` and stores the token on the user record for future server-side sends.
- Refreshed the app icon to use the venn diagram mark on the `c.surface` background so TestFlight builds reflect the latest brand palette.
- Supabase now mirrors PocketBase push tokens: added `users.push_token`, and the client updates both stores whenever registration succeeds (or clears).
- Introduced Supabase Edge Function `notifications` to send Expo pushes given a batch of recipient user IDs; PocketBase hooks (messages/items/memberships) call it for DMs, ref matches, copying from a profile, and community joins.
- Push notifications now prompt contextually after important actions (first DM, creating/joining chats) using smart permission checking: undetermined shows custom sheet, granted registers silently, denied prompts to open iOS settings. Removed the old push notification toggle from onboarding since permissions are now contextually requested.
- Implemented notification tap handling: message notifications navigate to conversation, ref activity notifications navigate to actor's profile, community join notifications navigate to group chat.
- Added iOS notification threading: messages group by conversationId, ref activity groups by refId so users see organized notification stacks instead of spam.
- Fixed double-notification bug: users who own a ref no longer receive both "copied from your grid" AND "also added this ref" notifications.
- **CRITICAL ARCHITECTURE: Global Bottom Sheet Dimming**
  - The app uses a centralized dimming system with `NavigationBackdrop` (`zIndex: 1000`) rendered at root level in `_layout.tsx`, positioned between `<Navigation>` and `<Stack>`.
  - All global sheets (Saves, Referencers, AddRefSheet, NewRefSheet, LogoutSheet, ProfileDetailsSheet, ProfileSettingsSheet, CommunityFormSheet, DirectMessageComposer, GroupMessageComposer, RemoveInterestSheet) MUST be rendered at root level in `_layout.tsx` AFTER the NavigationBackdrop.
  - Each sheet uses `animatedIndex` tied to a shared backdrop value (`moduleBackdropAnimatedIndex`, `detailsBackdropAnimatedIndex`, `otherProfileBackdropAnimatedIndex`, or `removeRefSheetBackdropAnimatedIndex`) from the store.
  - Sheets must have `zIndex: 10000` and `containerStyle={{ zIndex: 10000 }}` to appear above the NavigationBackdrop.
  - The NavigationBackdrop interpolates all backdrop animated indices to create a unified dim overlay that covers everything except elevated sheets.
  - **NEVER** render confirmation sheets or any global UI inside screen components—they will be trapped under the NavigationBackdrop and appear dimmed. Always add new global sheets to `_layout.tsx` and wire them through the store.
  - Sheet backdrop components should use BottomSheetBackdrop with `disappearsOnIndex={-1}` and `appearsOnIndex={0}` for proper coordination.
  - This architecture ensures the header and background dim in unison while sheets remain bright and properly elevated.
